<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet de Compagnonnage - {{ user.fullname }}</title>
    <style>
        {% include 'pdf/css_workbook.twig' %}
    </style>
</head>
<body style="padding: 20px;">
    <!-- Page de couverture -->
    <div class="cover-page">
        <div class="cover-header">
            <div class="company-logo">
                <div class="logo-placeholder">
                    <img src="images/logos/edf.png" alt="Logo EDF" style="width: 80px; height: 80px; object-fit: contain;">
                </div>
            </div>
            <div class="document-title">
                <h1>CARNET DE COMPAGNONNAGE</h1>
                <div class="subtitle">Certificat de fin de formation</div>
            </div>
        </div>

        <div class="cover-content">
            <div class="apprentice-info-full">
                <h2>Informations de l'apprenant</h2>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="label">Nom complet :</span>
                        <span class="value">{{ user.fullname }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">NNI :</span>
                        <span class="value">{{ user.nni ?? 'Non renseigné' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Email :</span>
                        <span class="value">{{ user.email }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Métier :</span>
                        <span class="value">{{ user.job ? user.job.name : 'Non renseigné' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Spécialité :</span>
                        <span class="value">{{ user.speciality ? user.speciality.name : 'Non renseigné' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Service :</span>
                        <span class="value">{{ user.service ? user.service.name : 'Non renseigné' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Date d'embauche :</span>
                        <span class="value">{{ user.hiringAt ? user.hiringAt|date('d/m/Y') : 'Non renseignée' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Tuteur :</span>
                        <span class="value">{{ user.mentor ? user.mentor.fullname : 'Non assigné' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Date de fin de formation :</span>
                        <span class="value">{{ user.hiringAt|date_modify("+364 days")|date("d/m/Y") }}</span>
                    </div>
                </div>
                
                <div class="completion-certificate">
                    <div class="certificate-text">
                        <p class="certificate-statement">
                            Nous certifions que <strong>{{ user.fullname }}</strong> a terminé avec succès 
                            son parcours de professionalisation pour le métier de <strong>{{ user.job ? user.job.name : 'non spécifié' }}</strong>
                            {% if user.speciality %} avec spécialisation en <strong>{{ user.speciality.name }}</strong>{% endif %}.
                        </p>
                        <p class="certificate-validation">
                            Toutes les compétences requises ont été acquises et validées par le tuteur référent.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="cover-footer">
            <div class="generation-info">
                <p>Document généré le {{ date_generation|date('d/m/Y à H:i') }}</p>
            </div>
        </div>
    </div>

    <!-- Pages de contenu -->
    <div class="content-page">
        <div class="page-header">
            <h1>Détail des compétences acquises</h1>
            <div class="header-info">
                <span>{{ user.fullname }} - {{ user.job ? user.job.name : 'Métier non renseigné' }}</span>
            </div>
        </div>

        <div class="content-section">
            <h2>Progression par domaine de compétences</h2>
            
            {% if logbook.themes is defined and logbook.themes|length > 0 %}
                {% for theme in logbook.themes %}
                    <div class="domain-section">
                        <h3>{{ theme.title }}</h3>
                        <div class="skills-grid">
                            {% for module in theme.modules %}
                                {% set action = null %}
                                {% for userAction in user.actions %}
                                    {% if userAction.module.id == module.id %}
                                        {% set action = userAction %}
                                    {% endif %}
                                {% endfor %}
                                <div class="skill-item {{ action and action.mentorValidatedAt ? 'completed' : 'pending' }}" style="{{ not loop.last ? 'margin-bottom: 10px;' : '' }}">
                                    <div class="skill-header">
                                        <span class="skill-name">{{ module.title }}</span>
                                        <span class="skill-status">
                                            {% if action and action.mentorValidatedAt %}
                                                <span style="color: #28a745; font-weight: bold;">[VALIDÉ]</span>
                                            {% elseif action and action.agentValidatedAt %}
                                                <span style="color:rgb(212, 159, 1);">[EN ATTENTE]</span>
                                            {% else %}
                                                <span style="color: #6c757d;">[EN COURS]</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% if module.description %}
                                        <p class="skill-description">{{ module.description }}</p>
                                    {% endif %}
                                    {% if action and action.mentorValidatedAt %}
                                        <p class="completion-date">Validée le {{ action.mentorValidatedAt|date('d/m/Y') }}</p>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data">
                    <p>Aucun thème disponible dans ce carnet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Nouvelle page pour les actions -->
    <div class="page-break"></div>
    
    <div class="content-page">
        <div class="page-header">
            <h1>Journal des actions réalisées</h1>
            <div class="header-info">
                <span>{{ user.fullname }} - Période de formation</span>
            </div>
        </div>

        <div class="content-section">
            {% if logbook.actions is defined and logbook.actions|length > 0 %}
                <div class="actions-timeline">
                    {% for action in logbook.actions %}
                        {% set actionStatus = 'pending' %}
                        {% if action.mentorValidatedAt %}
                            {% set actionStatus = 'completed' %}
                        {% elseif action.agentValidatedAt %}
                            {% set actionStatus = 'in_progress' %}
                        {% endif %}
                        <div class="action-item {{ actionStatus }}">
                            <div class="action-date">
                                {% if action.agentValidatedAt %}
                                    {{ action.agentValidatedAt|date('d/m/Y') }}
                                {% else %}
                                    Non datée
                                {% endif %}
                            </div>
                            <div class="action-content">
                                <h4>{{ action.module ? action.module.title : 'Action sans module' }}</h4>
                                {% if action.description %}
                                    <p class="action-description">{{ action.description }}</p>
                                {% endif %}
                                <div class="action-meta">
                                    <span class="action-status-badge status-{{ actionStatus }}">
                                        {% if actionStatus == 'completed' %}
                                            Validée par le tuteur
                                        {% elseif actionStatus == 'in_progress' %}
                                            Auto-validée (en attente tuteur)
                                        {% else %}
                                            En attente
                                        {% endif %}
                                    </span>
                                    {% if action.module %}
                                        <span class="action-skill">Module: {{ action.module.title }}</span>
                                    {% endif %}
                                </div>
                                {% if action.mentorComment %}
                                    <div class="mentor-comment">
                                        <strong>Commentaire du tuteur:</strong>
                                        <p>{{ action.mentorComment }}</p>
                                    </div>
                                {% endif %}
                                {% if action.agentComment %}
                                    <div class="mentor-comment" style="background: #f8f9fa; border-left-color: #6c757d;">
                                        <strong>Commentaire de l'apprenant:</strong>
                                        <p>{{ action.agentComment }}</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-data">
                    <p>Aucune action enregistrée dans ce carnet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Page de signatures -->
    <div class="page-break"></div>
    
    <div class="signature-page">
        <div class="signature-header">
            <h1>Validation du parcours de compagnonnage</h1>
            <div class="signature-subtitle">
                <p>Certification de fin de formation pour <strong>{{ user.fullname }}</strong></p>
                <p>Métier : {{ user.job ? user.job.name : 'Non spécifié' }}{% if user.speciality %} - {{ user.speciality.name }}{% endif %}</p>
            </div>
        </div>

        <div class="signature-content">
            <div class="signature-text">
                <p>Par la présente, nous certifions que l'apprenant mentionné ci-dessus a terminé avec succès son parcours de compagnonnage et a acquis toutes les compétences requises pour exercer son métier en autonomie.</p>
                <p>Cette certification atteste de la validation complète de tous les modules de formation par le tuteur référent.</p>
            </div>

            <div class="signatures-grid">
                <div class="signature-block-large">
                    <div class="signature-info">
                        <h4>L'apprenant</h4>
                        <p>{{ user.fullname }}</p>
                        <p class="signature-role">Bénéficiaire de la formation</p>
                    </div>
                    <div class="signature-area">
                        <div class="signature-line-large"></div>
                        <p class="signature-label">Signature et date</p>
                    </div>
                </div>

                <div class="signature-block-large" style="margin-top: 20px;">
                    <div class="signature-info">
                        <h4>Le tuteur</h4>
                        <p>{{ user.mentor ? user.mentor.fullname : 'Non assigné' }}</p>
                        <p class="signature-role">Tuteur référent</p>
                    </div>
                    <div class="signature-area">
                        <div class="signature-line-large"></div>
                        <p class="signature-label">Signature et date</p>
                    </div>
                </div>

                <div class="signature-block-large" style="margin-top: 20px;">
                    <div class="signature-info">
                        <h4>Le chef de service</h4>
                        <p>{{ user.service.chef ?: '' }}</p>
                        <p class="signature-role">Responsable de service</p>
                    </div>
                    <div class="signature-area">
                        <div class="signature-line-large"></div>
                        <p class="signature-label">Signature et date</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="signature-footer">
            <p>Document généré le {{ date_generation|date('d/m/Y à H:i') }}</p>
        </div>
    </div>
</body>
</html>