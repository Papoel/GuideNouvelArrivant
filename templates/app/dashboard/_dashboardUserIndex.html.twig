<div class="pageTitle">
    <h1>Tableau de bord</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('dashboard_index', {'nni': app.user.nni}) }}">
                    Accueil
                </a>
            </li>
            <li class="breadcrumb-item active">Tableau de bord</li>
        </ol>
    </nav>
</div>
<!-- End Page Title -->
<div class="col-lg-12">
    <div class="row">
        <!-- Agent Card -->
        {{ include('app/dashboard/cards/userCard.html.twig') }}
        <!-- End Agent Card -->

        <!-- Mentor Card -->
        {{ include('app/dashboard/cards/mentorCard.html.twig') }}
        <!-- End Mentor Card -->
    </div>
</div>
<!-- End Left side columns -->

<!-- Modal Bootstrap pour les commentaires -->
<section id="card-logbook">
    <div class="row mt-4">
        <div class="col-12">
            {% if logbooks %}
            {% for logbook in logbooks %}
                <div class="card info-card mentor-card shadow-sm rounded-4 mb-4 h-100">
                    <div class="card-header bg-white text-uppercase fw-bold border-bottom border-secondary border-opacity-25 ps-3">
                        <h5 class="mb-0">{{ logbook.name }}</h5>
                    </div>
                    <div class="card-body">
                        {% for theme in logbook.themes %}
                            <div class="accordion mt-3" id="theme-{{ theme.id }}">
                                <div class="accordion-item border-0">
                                    <h2 class="accordion-header" id="heading-{{ theme.id }}">
                                        <button class="accordion-button collapsed shadow-sm rounded-3 bg-primary-subtle text-dark"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#collapse-theme-{{ theme.id }}"
                                                aria-expanded="false"
                                                aria-controls="collapse-theme-{{ theme.id }}">
                                            {{ theme.title }}
                                            <span class="badge bg-primary rounded-pill ms-3">{{ theme.modules|length }}</span>
                                        </button>
                                    </h2>

                                    <div id="collapse-theme-{{ theme.id }}"
                                         class="accordion-collapse collapse"
                                         aria-labelledby="heading-{{ theme.id }}"
                                         data-bs-parent="#theme-{{ theme.id }}">
                                        <div class="accordion-body">
                                            <!-- Ajout du conteneur scrollable -->
                                            <div class="scrollable-modules">
                                                <ul class="list-group list-group-flush">
                                                    {% for module in theme.modules %}
                                                        {% set actionByCurrentUser = module.actions|filter(action => action.agentComment is not null and action.user == app.user) %}
                                                        {% set hasFilledActions = actionByCurrentUser|length > 0 %}
                                                        {% set moduleValidatedByMentor = module.actions|filter(action => action.mentorValidatedAt and action.user == app.user) %}
                                                        {% set moduleCommentedByMentor = module.actions|filter(action => action.mentorComment is not null and action.user == app.user) %}
                                                        <li id="module-{{ module.id }}"
                                                            class="list-group-item d-flex justify-content-between align-items-center py-2
                                                                {{ moduleCommentedByMentor is not empty ? 'bg-primary-subtle border border-primary rounded-1' : '' }}
                                                                {{ moduleValidatedByMentor is not empty ? 'bg-success-subtle border-0' : '' }}">
                                                            <span>{{ loop.index }} - {{ module.title }}</span>
                                                            <div class="d-flex gap-2">
                                                                {% if  moduleValidatedByMentor|length > 0 %}
                                                                    <span class="badge bg-success rounded-pill"
                                                                          data-bs-toggle="modal"
                                                                          data-bs-target="#userActionModal{{ module.id }}"
                                                                          style="cursor: pointer">
                                                                            <i class="bi bi-check-circle"></i> Validé
                                                                        </span>
                                                                {% else %}
                                                                    {% if hasFilledActions %}
                                                                        <a class="btn btn-sm btn-outline-primary"
                                                                           href="{{ path('action_edit', { 'nni': app.user.nni, 'moduleId': module.id, 'logbookId': logbook.id }) }}">
                                                                            <i class="bi bi-pencil-square"></i>
                                                                            Modifier
                                                                        </a>
                                                                    {% else %}
                                                                        <a class="btn btn-sm btn-primary"
                                                                           href="{{ path('action_edit', { 'nni': app.user.nni, 'moduleId': module.id, 'logbookId': logbook.id }) }}">
                                                                            <i class="bi bi-pencil-square"></i>
                                                                            Renseigner le module
                                                                        </a>
                                                                    {% endif %}
                                                                    {% if module.actions|filter(action => action.agentComment is not null and action.mentorComment is null and action.user == app.user)|length > 0 %}
                                                                        <button class="btn btn-sm btn-outline-secondary"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#userActionModal{{ module.id }}">
                                                                            <i class="bi bi-info-circle"></i>
                                                                            Commentaire agent
                                                                        </button>
                                                                    {% elseif module.actions|filter(action => action.mentorComment is not null and action.user == app.user)|length > 0 %}
                                                                        <button class="btn btn-sm btn-outline-success"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#userActionModal{{ module.id }}">
                                                                            <i class="bi bi-info-circle"></i>
                                                                            Commentaire tuteur
                                                                        </button>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <!-- Fin du conteneur scrollable -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            {% else %}
                <div class="card border-0 rounded-xl shadow-lg overflow-hidden position-relative card-logbook">
                    <div class="card-body p-0">
                        <div class="row g-0">
                            <div class="col-md-6 p-5 d-flex flex-column justify-content-center">
                                <h3 class="fw-bold mb-3 glitch-text" data-text="Aucun carnet disponible" style="color: #012970">Aucun carnet disponible</h3>
                                <p id="typewriter-text" class="lead text-muted mb-4"></p>
                                <div class="mt-4 fade-in-up">
                                    <a href="#" class="btn btn-primary btn-glow">Découvrir les carnets</a>
                                </div>
                            </div>
                            <div class="col-md-6 dark-gradient-background d-none d-md-flex align-items-center justify-content-center position-relative overflow-hidden">
                                <div class="hologram-effect"></div>
                                <div class="particle-system"></div>
                                <div class="floating-icon">
                                    <i class="bi bi-book fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .card-logbook {
                        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                        transition: all 0.3s ease;
                    }
                    .card-logbook:hover {
                        transform: translateY(-5px) rotate(1deg);
                        box-shadow: 0 1rem 3rem rgba(0,0,0,.3)!important;
                    }

                    .glitch-text {
                        position: relative;
                        color: #012970;
                    }
                    .glitch-text::before,
                    .glitch-text::after {
                        content: attr(data-text);
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                    }
                    .glitch-text::before {
                        left: 2px;
                        text-shadow: -2px 0 #ff00c1;
                        clip: rect(24px, 550px, 90px, 0);
                        animation: glitch-anim 3s infinite linear alternate-reverse;
                    }
                    .glitch-text::after {
                        left: -2px;
                        text-shadow: -2px 0 #00fff9;
                        clip: rect(85px, 550px, 140px, 0);
                        animation: glitch-anim 2.5s infinite linear alternate-reverse;
                    }

                    .dark-gradient-background {
                        background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460, #1a1a2e);
                        background-size: 400% 400%;
                        animation: subtle-shift 15s ease infinite;
                    }

                    .floating-icon {
                        position: absolute;
                        color: rgba(255,255,255,0.6);
                        animation: float 6s ease-in-out infinite;
                    }

                    .hologram-effect {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 200px;
                        height: 200px;
                        background: radial-gradient(circle, rgba(15, 52, 96, 0.6) 0%, transparent 70%);
                        opacity: 0.7;
                        filter: blur(10px);
                        animation: hologram 5s infinite alternate;
                    }

                    .particle-system::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
                        background-size: 30px 30px;
                    }

                    @keyframes glitch-anim {
                        0% { clip: rect(14px, 9999px, 76px, 0); }
                        20% { clip: rect(38px, 9999px, 33px, 0); }
                        40% { clip: rect(6px, 9999px, 98px, 0); }
                        60% { clip: rect(74px, 9999px, 71px, 0); }
                        80% { clip: rect(46px, 9999px, 40px, 0); }
                        100% { clip: rect(66px, 9999px, 64px, 0); }
                    }

                    @keyframes subtle-shift {
                        0%, 100% { background-position: 0% 50%; }
                        50% { background-position: 100% 50%; }
                    }

                    @keyframes float {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-20px); }
                    }

                    @keyframes hologram {
                        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
                        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.9; }
                    }
                </style>

            {% endif %}
        </div>
    </div>
</section>

{% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const text = "Désolé {{ app.user.firstname|capitalize }}, vous n'avez pas de carnet...";
            const element = document.getElementById('typewriter-text');
            let index = 0;

            function typeWriter() {
                if (index < text.length) {
                    element.innerHTML += text.charAt(index);
                    index++;
                    setTimeout(typeWriter, 50); // Ajustez la vitesse ici (50ms par caractère)
                }
            }

            typeWriter();
        });


    </script>
{% endblock %}
<!-- Modals pour afficher les commentaires des utilisateurs et tuteurs -->
{% for logbook in logbooks %}
    {% for theme in logbook.themes %}
        {% for module in theme.modules %}
            {% if module.actions|filter(action => action.agentComment is not null and action.agentComment|length > 0 and action.user == app.user or action.mentorComment is not null)|length > 0 %}
                <div class="modal fade" id="userActionModal{{ module.id }}" tabindex="-1"
                     aria-labelledby="userActionModalLabel{{ module.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content shadow-lg">
                            <div class="modal-header bg-light border-0">
                                <h3 class="modal-title text-dark" id="userActionModalLabel{{ module.id }}">
                                    <i class="bi bi-chat-dots me-2"></i> Commentaires
                                </h3>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                {% for action in module.actions %}
                                    {% if action.agentComment and action.user == app.user %}
                                        <div class="mb-4">
                                            <h5 class="text-primary">Commentaire de l'Agent</h5>
                                            <div class="bg-light p-3 border rounded">
                                                <p>{{ action.agentComment }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if action.mentorComment and action.user == app.user %}
                                        <div class="mt-4">
                                            <h5 class="text-success">Commentaire du Tuteur</h5>
                                            <div class="bg-light p-3 border rounded">
                                                <p>{{ action.mentorComment }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if action.mentorValidatedAt and action.user == app.user %}
                                        <div class="mt-4">
                                            <hr>
                                            <h5 class="text-success">Validation du Tuteur</h5>
                                            <div class="bg-secondary-light p-3 border rounded">
                                                <p>{{ action.mentorVisa }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Fermer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endfor %}
{% endfor %}
